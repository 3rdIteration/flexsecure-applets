#!/usr/bin/expect

spawn gpg --card-edit --command-fd=0 --status-fd=1 --expert --pinentry-mode loopback

expect -exact "*GET_LINE cardedit.prompt"
send -- "admin\r"

expect -exact "*GET_LINE cardedit.prompt"
send -- "passwd\r"

# Change User PIN
expect -exact "*GET_LINE cardutil.change_pin.menu"
send -- "1\r"

# Default User PIN
expect -exact "*GET_HIDDEN passphrase.enter"
send -- "123456\r"

# New User PIN
expect -exact "*GET_HIDDEN passphrase.enter"
send -- "1337420\r"

# Repeat new User PIN
expect -exact "*GET_HIDDEN passphrase.enter"
send -- "1337420\r"

# Change Admin PIN
expect -exact "GET_LINE cardutil.change_pin.menu"
send -- "3\r"

# Default Admin PIN
expect -exact "*GET_HIDDEN passphrase.enter"
send -- "12345678\r"

# New Admin PIN
expect -exact "*GET_HIDDEN passphrase.enter"
send -- "13371234\r"

# Repeat new Admin PIN
expect -exact "*GET_HIDDEN passphrase.enter"
send -- "13371234\r"

# Get out of passwd menu
expect -exact "*GET_LINE cardutil.change_pin.menu"
send -- "q\r"

# Set desired key attributes.

expect -exact "*GET_LINE cardedit.prompt"
send -- "key-attr\r"

# Signature key.
expect -exact "*GET_LINE cardedit.genkeys.algo"
# RSA
send -- "1\r"

expect -exact "*GET_LINE cardedit.genkeys.size"
send -- "2048\r"

# Encryption key.
expect -exact "*GET_LINE cardedit.genkeys.algo"
# RSA
send -- "1\r"

expect -exact "*GET_LINE cardedit.genkeys.size"
send -- "2048\r"

# Authentication key.
expect -exact "*GET_LINE cardedit.genkeys.algo"
# RSA
send -- "1\r"

expect -exact "*GET_LINE cardedit.genkeys.size"
send -- "2048\r"

# Time to generate.

expect -exact "*GET_LINE cardedit.prompt"
send -- "generate\r"

expect -exact "*GET_LINE cardedit.genkeys.backup_enc"
send -- "n\r"

# Send new Admin PIN
expect -exact "*GET_HIDDEN passphrase.enter"
send -- "13371234\r"

# Send new User PIN
expect -exact "*GET_HIDDEN passphrase.enter"
send -- "1337420\r"

expect -exact "*GET_LINE keygen.valid"
send -- "10y\r"

expect -exact "*GET_LINE keygen.name"
send -- "CI Test\r"

expect -exact "*GET_LINE keygen.email"
send -- "test@example.com\r"

expect -exact "*GET_LINE keygen.comment"
send -- "CI Testing Key\r"

# Send new User PIN
expect -exact "*GET_HIDDEN passphrase.enter"
send -- "1337420\r"

# Quit
expect -exact "*GET_LINE cardedit.prompt"
send -- "quit\r"

expect eof
