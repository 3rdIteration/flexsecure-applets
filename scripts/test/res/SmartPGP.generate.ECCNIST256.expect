#!/usr/bin/expect

spawn gpg --card-edit --command-fd=0 --status-fd=1 --expert --pinentry-mode loopback

expect "*GET_LINE cardedit.prompt*\n"
send -- "admin\r"

# Set desired key attributes.

expect "*GET_LINE cardedit.prompt*\n"
send -- "key-attr\r"

# Signature key.
expect "*GET_LINE cardedit.genkeys.algo*\n"
# ECC
send -- "2\r"

expect "*GET_LINE keygen.curve*\n"
# NIST P-256
send -- "3\r"

# Send Admin PIN
expect "*GET_HIDDEN passphrase.enter*\n"
send -- "12345678\r"

# Encryption key.
expect "*GET_LINE cardedit.genkeys.algo*\n"
# ECC
send -- "2\r"

expect "*GET_LINE keygen.curve*\n"
# NIST P-256
send -- "3\r"

# Send Admin PIN
expect "*GET_HIDDEN passphrase.enter*\n"
send -- "12345678\r"

# Authentication key.
expect "*GET_LINE cardedit.genkeys.algo*\n"
# ECC
send -- "2\r"

expect "*GET_LINE keygen.curve*\n"
# NIST P-256
send -- "3\r"

# Send Admin PIN
expect "*GET_HIDDEN passphrase.enter*\n"
send -- "12345678\r"

# Generate
expect "*GET_LINE cardedit.prompt*\n"
send -- "generate\r"

expect "*GET_LINE cardedit.genkeys.backup_enc*\n"
send -- "n\r"

# Send Admin PIN
expect "*GET_HIDDEN passphrase.enter*\n"
send -- "12345678\r"

# Send User PIN
expect "*GET_HIDDEN passphrase.enter*\n"
send -- "123456\r"

expect "*GET_LINE keygen.valid*\n"
send -- "10y\r"

expect "*GET_LINE keygen.name*\n"
send -- "CI Test\r"

expect "*GET_LINE keygen.email*\n"
send -- "test@example.com\r"

expect "*GET_LINE keygen.comment*\n"
send -- "CI Testing Key\r"

# Send new User PIN
expect "*GET_HIDDEN passphrase.enter*\n"
send -- "123456\r"

# Quit
expect "*GET_LINE cardedit.prompt*\n"
send -- "quit\r"

expect eof
