# Universal Two-Factor Authentication using FIDO

**FIDO** (Fast IDentity Online) **U2F** (Universal 2nd Factor) is a standard for two-factor authentication. It is extended and superseded by FIDO2, but still widely used. 

The applet requires an attestation certificate. This certificate can be a default one, or generated by you, or an official one signed by a company like Vivokey or Yubico. You don't want to generate a unique certificate for each token, because that would make the tokens uniquely identifiable, leading to privacy concerns. 

The attestation certificate is used to sign certificates for transport when you register with a service. The token manufacturer (e.g. Vivokey) can also use this certificate (which they sign using their certificate authority) to validate the authenticity and model of the token and applet.

**FIDO2 CTAP2** (Client to Authenticator Protocol) is an extension and improvement over FIDO U2F, and remains backwards-compatible to U2F.

The FIDO2 applet is still in development, and not completely finished. For example, Windows Hello is not supported yet. Stay tuned. It is also not officially certified.

If you are feeling lucky, you can however already test the FIDO2 applet.

## Applet Information

### FIDO U2F (recommended)

- Repository: https://github.com/darconeous/u2f-javacard
- Binary name: `U2FApplet.cap`
- Download: https://github.com/StarGate01/flexsecure-applets/releases
- AID: `a0:00:00:06:47:2F:00:01`, Package: `a0:00:00:06:47:2F:00`
- Storage requirements:
  - Persistent: `8020` bytes
  - Transient reset: `865` bytes
  - Transient deselect: `0` bytes

### FIDO2 CTAP2 (in development)

- Repository: https://github.com/VivoKey/vk-u2f (forked from u2f-javacard)
- Binary name: `CTAP2.cap`
- Download: https://github.com/StarGate01/flexsecure-applets/releases
- AID: `a0:00:00:06:47:2F:00:01`, Package: `a0:00:00:06:47:2F:00`

## Compiling the Applet Yourself

Setup your environment as described in *JavaCard Development Setup* .

Use git to clone the sources recursively, and change into the directory. To compile, run `JC_HOME=<sdks>/jc304_kit ant`, replacing `<sdks>` with the path to your JavaCard SDKs.

## Installing the Applet

You can not use the U2F applet at the same time as the FIDO2 one because they use the same AID.

Loading the attestation certificate requires manual steps as of now, but Vivokey and I are planning to release tools for U2F and FIDO2 attestation certificate loading sometime in the future.

### Generate Attestation Certificate

You can also generate your own attestation certificate. This makes your token unique, which is maybe not something you want - but then again, I recon the number of tokens using the default key can be counted on maybe two hands maximum.

In the future, Vivokey plans offer signed certificates using their own certificate authority in some way. It is unclear if or how these would be coming to the FlexSecure, as they require the more protected environment of the Apex Flex in order to not leak.

Creating certificates used to be quite the involved task requiring advanced knowledge of `openssl` commands, but I have written a small tool to simplify the process. Install Python3, and the `cryptography`, `asn1`, and `pyscard` modules (e.g. using Pip). Then, clone or download https://github.com/StarGate01/fido-attestation-loader .

If you specify no flags, the script will use the default file names `attestation.der`, `attestation_key.p8`, `ca.der`, `ca_key.p8`, and `settings.ini`. If you want to, you can edit the metadata in `settings.ini`.

First, generate a certificate authority, the script will ask you for a passphrase to secure the private key.

```
./attestation.py ca create
```

Next, generate an attestation certificate and sign it using the CA. You have to create another passphrase to protect the private key of the attestation certificate.

```
./attestation.py cert create 
```

Then, you can derive the applet installation parameter by running, for FIDO U2F:

```
./attestation.py cert show -m u2f
```

For FIDO2:

```
./attestation.py cert show -m fido2
```

The attestation script has a lot more flags to control which files to use, and to provide passphrases via the arguments instead of interactively typing them. It also provides functionality to validate a certificate gainst an certificate authority. See the `-h` help command for more details.

Use GlobalPlatformPro (GPP) from https://github.com/martinpaljak/GlobalPlatformPro/releases to install the applet:

```
gp -install U2FApplet.cap --params INSTALLPARAM
```

The parameter data (`INSTALLPARAM`) is `00`, joined to the length in bytes of the public attestation certificate (16 bit integer = 2 bytes), and joined to the private key (32 bytes). See https://github.com/darconeous/u2f-javacard/blob/master/README.md for more info. You can copy it from the last line of the output of `./attestation.py cert show`.

Listing the applets using `gp --list` should print something like this:

```
APP: A0000006472F0001 (SELECTABLE)
     Parent:  A000000151000000
     From:    A000000617004F97A2E95001

PKG: A000000617004F97A2E95001 (LOADED)
     Parent:  A000000151000000
     Version: 1.1
     Applet:  A000000617004F97A2E94901
```

Next, you have to load the public attestation certificate by sending a few chained APDUs. The DER encoded public certificate has to be chopped into `128` byte chunks, which are sent attached to a small header. The header is `80 01 HHLL KK`, with `HHLL` being a 16 bit integer offset of that chunk, and `KK` being the chunk length (hex `80`, usually smaller for the last chunk). Before sending the certificate, selecting the applet is required.

This task is covered by the attestation script as well, for FIDO U2F:

```
./attestation.py cert upload -m u2f
```

For FIDO2:

```
./attestation.py cert upload -m fido2
```

You might have to specify your PCSC reader index using `-r`, use `-l` to list all readers.

See also https://gist.github.com/darconeous/adb1b2c4b15d3d8fbc72a5097270cdaf for more info on these APDUs.

## Using the Applet

Using the applet in the web requires a modern browser with support for FIDO. NFC tokens don't work on Linux (yet, see https://twitter.com/FIDOAlliance/status/1278331283874156544).

You can use the *Yubikey WebAuthn test page* at https://demo.yubico.com/webauthn-technical/registration to test your token.

On Android, you can use the *FIDO / Webauthn Example* App at https://play.google.com/store/apps/details?id=de.cotech.hw.fido.example for testing (Use the U2F tab).

## Sources and Further Reading

- https://en.wikipedia.org/wiki/Universal_2nd_Factor
- https://www.yubico.com/authentication-standards/fido-u2f/
- https://fidoalliance.org/fido-technotes-the-truth-about-attestation/
- https://gist.github.com/darconeous/adb1b2c4b15d3d8fbc72a5097270cdaf
- https://fidoalliance.org/specs/fido-u2f-v1.2-ps-20170411/fido-u2f-raw-message-formats-v1.2-ps-20170411.html#examples
- https://demo.yubico.com/webauthn-technical/registration
- https://en.wikipedia.org/wiki/FIDO2_Project
- https://www.1kosmos.com/authentication/fido2-authentication/
- https://research.kudelskisecurity.com/2020/02/12/fido2-deep-dive-attestations-trust-model-and-security/
- https://fidoalliance.org/specs/fido-v2.0-rd-20180702/fido-client-to-authenticator-protocol-v2.0-rd-20180702.html
- https://play.google.com/store/apps/details?id=de.cotech.hw.fido.example
- https://research.kudelskisecurity.com/2020/02/12/fido2-deep-dive-attestations-trust-model-and-security/
- https://developers.yubico.com/U2F/Attestation_and_Metadata/
- https://fidoalliance.org/specs/fido-u2f-v1.2-ps-20170411/fido-u2f-authenticator-transports-extension-v1.2-ps-20170411.html#fido-u2f-certificate-extensions
- https://github.com/StarGate01/fido-attestation-loader

Improve this document: https://github.com/StarGate01/flexsecure-applets/tree/master/docs