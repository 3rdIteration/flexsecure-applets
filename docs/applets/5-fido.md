# Universal Two-Factor Authentication using FIDO

**FIDO** (Fast IDentity Online) **U2F** (Universal 2nd Factor) is a standard for two-factor authentication. It is extended and superseded by FIDO2, but still widely used. 

The applet requires an attestation certificate. This certificate can be a default one, or generated by you, or an official one signed by a company like Vivokey or Yubico. You don't want to generate a unique certificate for each token, because that would make the tokens uniquely identifiable, leading to privacy concerns. 

The attestation certificate is used to sign certificates for transport when you register with a service. The token manufacturer (e.g. Vivokey) can also use this certificate (which they sign using their certificate authority) to validate the authenticity and model of the token and applet.

**FIDO2 CTAP2** (Client to Authenticator Protocol) is an extension and improvement over FIDO U2F, and remains backwards-compatible to U2F.

The FIDO2 applet is still in development, and not completely finished. For example, Windows Hello is not supported yet. The attestation certificate loading procedure is not yet properly documented, and neither is the generation of such a certificate. Stay tuned.

## Applet Information

### FIDO U2F (recommended)

- Repository: https://github.com/darconeous/u2f-javacard
- Binary name: `U2FApplet.cap`
- Download: https://github.com/StarGate01/flexsecure-applets/releases
- AID: `A0:00:00:06:47:2F:00:01`, Package: `a0:00:00:06:17:00:4f:97:a2:e9:50:01`

### FIDO2 CTAP2 (in development)

- Repository: https://github.com/VivoKey/vk-u2f (forked from u2f-javacard)
- Binary name: `CTAP2.cap`
- Download: https://github.com/StarGate01/flexsecure-applets/releases
- AID: `A0:00:00:06:47:2F:00:01`, Package: `A0:00:00:06:47:2F:00:01`

## Compiling the Applet Yourself

Setup your environment as described in *JavaCard Development Setup* .

Use git to clone the sources recursively, and change into the directory. To compile, run `JC_HOME=<sdks>/jc304_kit ant`, replacing `<sdks>` with the path to your JavaCard SDKs.

## Installing the Applet

You can not use the U2F applet at the same time as the FIDO2 one because they use the same AID.

Loading the attestation certificate requires manual steps as of now, but Vivokey and I are planning to release tools for U2F and FIDO2 attestation certificate loading sometime in the future.

### Default Attestation Certificate

You can use the default example U2F attestation certificate, which I have extracted from https://fidoalliance.org/specs/fido-u2f-v1.2-ps-20170411/fido-u2f-raw-message-formats-v1.2-ps-20170411.html#examples and converted to the OpenSSL x509 / ECC PEM format. Note that it is no longer valid according to its date, but it still works. Then again, it was never signed by any company, so it was never seen as valid in the first place.

`attestation.pem`:
```
-----BEGIN CERTIFICATE-----
MIIBPDCB5KADAgECAgpHkBKAABFVlXNSMAoGCCqGSM49BAMCMBcxFTATBgNVBAMT
DEdudWJieSBQaWxvdDAeFw0xMjA4MTQxODI5MzJaFw0xMzA4MTQxODI5MzJaMDEx
LzAtBgNVBAMTJlBpbG90R251YmJ5LTAuNC4xLTQ3OTAxMjgwMDAxMTU1OTU3MzUy
MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEjWF+ZclQjmS8xWc6yCpnmdo8FEZo
LCWMRj//31jf0vo+bDeLU9eVxKTf+0GZ7deGLyOrrwIDtLiRG6BWmZThATAKBggq
hkjOPQQDAgNHADBEAiBgzbYGHpwiJi0arB2W2McIKbI2ZTHdomiDLLg2vNMN+gIg
YxsUWfCeYzAFVyLI2Jt/SIg7kIm4jWDR2XlZArMEEN8=
-----END CERTIFICATE-----
```

`attestation_key.pem`:
```
-----BEGIN PRIVATE KEY-----
MEECAQAwEwYHKoZIzj0CAQYIKoZIzj0DAQcEJzAlAgEBBCDz/MwNANgDGVT5CGTU
PCR/S/XwZlxrUMwXdJon0c92ZA==
-----END PRIVATE KEY-----
```

This is the one used in the installation instructions below.

### Generate Attestation Certificate

You can also generate your own attestation certificate. Install `openssl` and `xxd` (or any binary hex viewer).

Create a file `attestation.config`, you can add more information if you want to:

```
[req]
distinguished_name = req_dn
attributes = req_att
x509_extensions = req_ext
req_extensions = req_ext
prompt = no

[req_dn]
CN=FlexSecure U2F Token

[req_att]

[req_ext]
basicConstraints = critical,CA:FALSE
1.3.6.1.4.1.45724.2.1.1 = ASN1:FORMAT:BITLIST,BITSTRING:3
```

The x509 `1.3.6.1.4.1.45724.2.1.1` extension limits this token to the NFC transport type (`3`).

Next, generate the private key (`attestation_key.pem`) and certificate signing request (`attestation.csr`):

```
openssl ecparam -genkey -noout -name prime256v1 -out attestation_key.pem

openssl req -config attestation.config -new -sha256 -key attestation_key.pem -out attestation.csr
```

Then, self-sign it (e.g. for 10 years) to generate the final certificate (`attestation.pem`):

```
openssl req -x509 -config attestation.config -extensions req_ext -sha256 -key attestation_key.pem -in attestation.csr -out attestation.pem -days 3650
```

Creating and signing using a proper certificate authority is out of scope for this document.

Next, extract the private key (32 bytes), look for `priv`:

```
openssl ec -in attestation_key.pem -text -noout
```

The bytes for the certificate are just the verbatim DER encoding:

```
openssl x509 -outform der -in attestation.pem -out attestation.der

xxd -c 128 -p attestation.der
wc -c < attestation.der
```

Use GlobalPlatformPro (GPP) from https://github.com/martinpaljak/GlobalPlatformPro/releases to install the applet:

```
gp -install U2FApplet.cap --create A0000006472F0001 --params 000140f3fccc0d00d8031954f90864d43c247f4bf5f0665c6b50cc17749a27d1cf7664
```

The parameter data is `00`, the length of the public attestation certificate (hex `0140`), and the private key (32 bytes). See https://github.com/darconeous/u2f-javacard/blob/master/README.md for more info.

Listing the applets using `gp --list` should print something like this:

```
APP: A0000006472F0001 (SELECTABLE)
     Parent:  A000000151000000
     From:    A000000617004F97A2E95001

PKG: A000000617004F97A2E95001 (LOADED)
     Parent:  A000000151000000
     Version: 1.1
     Applet:  A000000617004F97A2E94901
```

Next, you have to load the public attestation certificate by sending a few chained APDUs. The DER encoded public certificate has to be chopped into `128` byte chunks, which are sent attached to a small header. The header is `80 01 HHLL KK`, with `HHLL` being a 16 bit integer offset of that chunk, and `KK` being the chunk length (hex `80`, usually smaller for the last chunk). Before sending the certificate, a small preamble command is required.

```
gp -d -v -a "00 A4 04 00 08 A0 00 00 06 47 2F 00 01" -a "80 01 0000 80 3082013c3081e4a003020102020a47901280001155957352300a06082a8648ce3d0403023017311530130603550403130c476e756262792050696c6f74301e170d3132303831343138323933325a170d3133303831343138323933325a3031312f302d0603550403132650696c6f74476e756262792d302e342e312d34373930" -a "80 01 0080 80 313238303030313135353935373335323059301306072a8648ce3d020106082a8648ce3d030107034200048d617e65c9508e64bcc5673ac82a6799da3c1446682c258c463fffdf58dfd2fa3e6c378b53d795c4a4dffb4199edd7862f23abaf0203b4b8911ba0569994e101300a06082a8648ce3d0403020347003044022060cd" -a "80 01 0100 40 b6061e9c22262d1aac1d96d8c70829b2366531dda268832cb836bcd30dfa0220631b1459f09e6330055722c8d89b7f48883b9089b88d60d1d9795902b30410df"
```

See also https://gist.github.com/darconeous/adb1b2c4b15d3d8fbc72a5097270cdaf for more info on these APDUs.

## Using the Applet

Using the applet in the web requires a modern browser with support for FIDO. NFC tokens don't work on Linux (yet, see https://twitter.com/FIDOAlliance/status/1278331283874156544).

You can use the *Yubikey WebAuthn test page* at https://demo.yubico.com/webauthn-technical/registration to test your token.

On Android, you can use the *FIDO / Webauthn Example* App at https://play.google.com/store/apps/details?id=de.cotech.hw.fido.example for testing (Use the U2F tab).

## Sources and Further Reading

- https://en.wikipedia.org/wiki/Universal_2nd_Factor
- https://www.yubico.com/authentication-standards/fido-u2f/
- https://fidoalliance.org/fido-technotes-the-truth-about-attestation/
- https://gist.github.com/darconeous/adb1b2c4b15d3d8fbc72a5097270cdaf
- https://fidoalliance.org/specs/fido-u2f-v1.2-ps-20170411/fido-u2f-raw-message-formats-v1.2-ps-20170411.html#examples
- https://demo.yubico.com/webauthn-technical/registration
- https://en.wikipedia.org/wiki/FIDO2_Project
- https://www.1kosmos.com/authentication/fido2-authentication/
- https://research.kudelskisecurity.com/2020/02/12/fido2-deep-dive-attestations-trust-model-and-security/
- https://fidoalliance.org/specs/fido-v2.0-rd-20180702/fido-client-to-authenticator-protocol-v2.0-rd-20180702.html
- https://play.google.com/store/apps/details?id=de.cotech.hw.fido.example
- https://research.kudelskisecurity.com/2020/02/12/fido2-deep-dive-attestations-trust-model-and-security/
- https://developers.yubico.com/U2F/Attestation_and_Metadata/
- https://fidoalliance.org/specs/fido-u2f-v1.2-ps-20170411/fido-u2f-authenticator-transports-extension-v1.2-ps-20170411.html#fido-u2f-certificate-extensions

Improve this document: https://github.com/StarGate01/flexsecure-applets/tree/master/docs